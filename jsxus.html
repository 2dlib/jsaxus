<!DOCTYPE HTML>
<!-- https://labs.mozilla.com/forum/index.php/topic,58.0.html -->
<!-- http://canvex.lazyilluminati.com/misc/photos.html -->
<!-- todo: persistent storage of the scripts every time they are run, needs a light weight sketchbook/version control -->
<!-- todo: mouse controlled translation / rotation of the entire scene -->
<title>jsxus</title>

<style>
body {
	font-family: sans-serif;
	background: white;
	color: black;
	margin: 0;
}
label {
	display: block;
	width: 100%;
}
small {
	position: absolute;
	bottom: 0.5em;
}
</style>
<script src="jquery-1.2.3.min.js" type="text/javascript" charset="utf-8"></script>

<script type="application/javascript;version=1.7">
var audiolevel = 0;
var gl;
function audioIn(level){
	if(level>-1){
		// this smoothing is working but possibly not fast enough.
		audiolevel = (level+audiolevel)/2;
		// $("#bouncer").css({width:level});
	}
}

//tabs in text area script cribbed from: http://l4x.org/261/
Number.prototype.times = function(F){
	for(var i=0;i<this;i++){
		F(i);
	}
}

function insertTab(event,obj) {
    var tabKeyCode = 9;
    if (event.which) // mozilla
        var keycode = event.which;
    else // ie
        var keycode = event.keyCode;
    if (keycode == tabKeyCode) {
        if (event.type == "keydown") {
            if (obj.setSelectionRange) {
                // mozilla
                var s = obj.selectionStart;
                var e = obj.selectionEnd;
                obj.value = obj.value.substring(0, s) + 
                    "\t" + obj.value.substr(e);
                obj.setSelectionRange(s + 1, s + 1);
                obj.focus();
            } else if (obj.createTextRange) {
                // ie
                document.selection.createRange().text="\t"
                obj.onblur = function() { this.focus(); this.onblur = null; };
            } else {
                // unsupported browsers
            }
        }
        if (event.returnValue) // ie ?
            event.returnValue = false;
        if (event.preventDefault) // dom
            event.preventDefault();
        return false; // should work in all browsers
    }
    return true;
}

function load_image(gl, img, title)
{
	var [id] = gl.genTextures(1);
	gl.bindTexture(gl.TEXTURE_2D, id);
	gl.texParameter(gl.TEXTURE_2D, gl.GENERATE_MIPMAP, true);
	gl.texParameter(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR);
	gl.texParameter(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
	
	if ((img.width & (img.width-1)) || (img.height & (img.height-1)))
	{
		// not power-of-two, so resize it using a 2d canvas
		var w = next_pow2(img.width);
		var h = next_pow2(img.height);
		var canvas = document.createElement('canvas');
		canvas.width = w;
		canvas.height = h;
		var ctx = canvas.getContext('2d');
		ctx.drawImage(img, 0, 0, w, h);
		gl.texImage2DHTML(gl.TEXTURE_2D, canvas);
	}
	else
	{
		gl.texImage2DHTML(gl.TEXTURE_2D, img);
	}
	image_buffer.push({ id:id, title:title });
	status("Buffered " + image_buffer.length + " images");
}

function next_pow2(n)
{
	return Math.pow(2, Math.ceil(Math.log(n) / Math.LN2));
}
var lastkey = "";
$(document).ready(function(){
	 $(document).keydown(function(e){
		if(lastkey == 17 && e.which==75){
			// console.log(e.which);
			eval($("#code").val());
			return false;
		}else{
			lastkey = e.which;
		}
	});
	$(document).keyup(function(e){
		// console.log(lastkey);
		
		if(e.which==17){
			lastkey = 0;
		}
	});
	
	// before loading the gl, set the canvas to full width
	// $('#c').css({width:100%});
	var canvas = document.getElementById('c');
	try {gl = canvas.getContext('moz-gles11'); } catch (e) {}
	if (! gl)
	{
		alert("Sorry, your browser does not have the moz-gles11 canvas extension");
		canvas.parentNode.replaceChild(canvas.firstChild, canvas);
		return;
	}
	everyframe = function(){
		for(i=0;i<3;i++){
			// gl.rotate(speed*t*i*1.50, .8, .4, 0);
			// gl.translate(i*0.202*audiolevel, 0, 0);
			// gl.rotate(170, 0, 1, 0);
			// gl.rotate(speed*t*502.3, 1, .4, .3);
			drawPlane();
		}

	}
	var background = [0, 0, 0, 0];
	// var background = [1, 1, 1, 1];


	gl.matrixMode(gl.PROJECTION);
	gl.loadIdentity();
	gl.gluPerspective(45, 1, 0.1, 100);

	gl.matrixMode(gl.MODELVIEW);

	gl.clearColor(background[0], background[1], background[2], 1);

	gl.enable(gl.DEPTH_TEST);
	gl.cullFace(gl.BACK);
	gl.enable(gl.CULL_FACE);
	gl.enable(gl.TEXTURE_2D);
	

	// gl.enable(gl.BLEND);
	// gl.blendFunc(gl.ONE, gl.ONE);
	gl.enable(gl.LIGHTING);
	gl.light(gl.LIGHT0, gl.AMBIENT, [1, 1, 1, 1]);
	gl.light(gl.LIGHT0, gl.DIFFUSE, [1, 1, 1, 1]);
	gl.light(gl.LIGHT0, gl.POSITION, [100, 0, 500, 0]);
	gl.light(gl.LIGHT0, gl.SPECULAR, [1, 1, 1, 1]);
	
	// gl.material(gl.FRONT_AND_BACK, gl.SPECULAR, [1,0,0,0.4]);
	// gl.material(gl.FRONT_AND_BACK, gl.SHININESS, 0);
	// gl.enable(gl.MATERIAL0);
	
	gl.enable(gl.LIGHT0);


 
	gl.enableClientState(gl.VERTEX_ARRAY);
	gl.enableClientState(gl.NORMAL_ARRAY);
	gl.enableClientState(gl.COLOR_ARRAY);
	gl.enableClientState(gl.TEXTURE_COORD_ARRAY);

	planeObject = function(){
		this.vertices = [
			-1,-1,0, 1,-1,0, -1,1,0,
			-1,1,0, 1,-1,0, 1,1,0,

			1,-1,0, -1,-1,0, -1,1,0,
			1,-1,0, -1,1,0, 1,1,0,
		];
		this.texcoords = [
			0,1, 1,1, 0,0,
			0,0, 1,1, 1,0,
			0,1, 1,1, 1,0,
		   	0,1, 1,0, 0,0,
		];
		this.normals = [
			0,0,1, 0,0,1, 0,0,1,
			0,0,1, 0,0,1, 0,0,1,
			0,0,-1, 0,0,-1, 0,0,-1,
			0,0,-1, 0,0,-1, 0,0,-1,
		];
		this.colors = [
			1,0,1,1, 0,0,1,1, 1,0,1,1,
			1,0,1,1, 0,0,1,1, 1,0,1,1,
			1,0,1,1, 0,0,1,1, 1,0,1,1,
			1,0,1,1, 0,0,1,1, 1,0,1,1,
		];
		this.vertex_buffer = gl.createBuffer(gl.STATIC_DRAW, 3, gl.FLOAT, this.vertices);
		this.texcoord_buffer = gl.createBuffer(gl.STATIC_DRAW, 2, gl.FLOAT, this.texcoords);
		this.normal_buffer = gl.createBuffer(gl.STATIC_DRAW, 3, gl.FLOAT, this.normals);
		this.color_buffer = gl.createBuffer(gl.STATIC_DRAW, 4, gl.FLOAT, this.colors);
		
	}
	
	var color = function(r, g, b, a){
		gl.material(gl.FRONT_AND_BACK, gl.AMBIENT, [r, g, b, a]);		
	}
	var scale = function(x, y, z){
		gl.scale(x, y, z);
	}
	var translate = function(x, y, z){
		gl.translate(x, y, z);
	}
	var rotate = function(a, x, y, z){
		gl.rotate(a, x, y, z);
	}
	var push = function(){
		gl.pushMatrix();
	}
	var pop = function(){
		gl.popMatrix();
	}
	plane = new planeObject();
	var drawPlane = function(){
		gl.vertexPointer(plane.vertex_buffer);
		gl.texCoordPointer(plane.texcoord_buffer);
		gl.normalPointer(plane.normal_buffer);
		gl.colorPointer(plane.color_buffer);
		// if we are doing wireframe mode
		// gl.drawArrays(gl.LINES, 0, plane.vertices.length / 3);
		
		gl.drawArrays(gl.TRIANGLES, 0, plane.vertices.length / 3);
	}
	
	// should probably switch this to use its own
	// proper set of vertices, rather than running off the plane
	var drawcube = function(){
		drawPlane();		
		
		gl.rotate(90, 1, 0, 0);
		gl.translate(0, 1, 1);
		drawPlane();		
		
		gl.rotate(90, 0, 1, 0);
		gl.translate(1, 0, 1);
		drawPlane();		

		gl.rotate(90, 0, 1, 0);
		gl.translate(1, 0, 1);
		drawPlane();		
	
		gl.rotate(90, 0, 1, 0);
		gl.translate(1, 0, 1);
		drawPlane();		

		gl.rotate(90, 1, 0, 0);
		gl.translate(0, -1, -1);
		drawPlane();		
	}
	
	var t = 0;
	var turn = 0;
	var speed = 0.002;
	var img_id = 0;
	
	var tex = function(img_id){
		// this isn't working for shit, will crash your browser. should seperate into a loader function and a draw function.
		var i = new Image();
		var title = 'thing';
		i.onload = function () { load_image(gl, this, title) };
		i.src = $('#'+img_id).eq(0).attr("src");
		// i.src = "http://www.heathersanimations.com/dance2/01.gif";		
		
	}
	
	setInterval(function() {
		if (document.getElementById('pause').checked)
			return;

		// 
		
		gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
		
		gl.loadIdentity();

		// inital translation and rotation, should be linked to a camera object
		gl.translate(0, 0, -30.0)
		gl.rotate(45, 1, 1, 0);
		
		gl.pushMatrix();
		gl.gluLookAt(
				0, 0, 3.5,
				0, 0, 0,
				0, 1, 0);
		
		if(everyframe){
			everyframe();
		}
				
		gl.popMatrix();
		gl.swapBuffers();
		
	}, 30);
	
	$("#code").keydown(function(eventObject){
		insertTab(eventObject,this);
	})
	
	$("#run_code").click(function(){
		eval($("#code").val());
	});
});

var everyframe = function(){
	
}
window.addEventListener('load', function ()
{

}, false);

window.loaded_first_script = true;
</script>
<script>
if (! window.loaded_first_script)
{
	alert("Sorry, your browser does not support JavaScript 1.7");
	var canvas = document.getElementById('c');
	canvas.parentNode.replaceChild(canvas.firstChild, canvas); // oops, doesn't work in Opera
}
</script>

<canvas width="800" height="600" id="c"></canvas>
<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=8,0,0,0" width="550" height="138" id="audioin" align="middle">
<param name="allowScriptAccess" value="sameDomain" />
<param name="movie" value="audioin.swf" /><param name="quality" value="high" /><param name="bgcolor" value="#666666" /><embed src="audioin.swf" quality="high" bgcolor="#666666" width="550" height="138" name="audioin" align="middle" allowScriptAccess="sameDomain" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" />
</object>

<textarea name="code" rows="8" cols="40" id='code' style='position:absolute;top:0;left:0;border:0;background:none;color:#fff;padding:10px;width:800px;height:600px;'></textarea>
<p id='run_code'>run code</p>
<form onsubmit="flush_buffer(); return false">
<table>
	<tr>
		<td><label for="pause">Pause</label>
		<td><input type="checkbox" id="pause">
	</tr>
</table>
</form>

<h2>Ctrl+K to run</h2>

code to be entered:
<pre style='width:200px'>
	var t = 0;
	var turn = 0;
	var speed = 0.002;
	var img_id = 0;
	
	everyframe = function(){
		t++;
		for(i=0;i&lt;3;i++){
			// gl.rotate(speed*t*i*1.50, .8, .4, 0);
			gl.translate(i*0.202*audiolevel, 0, 0);
			gl.rotate(speed*t*502.3, 1, .4, .3);
			drawcube();
		}
	}
	
	//more code:
	var t=0;
	everyframe = function(){
		t += audiolevel;
		gl.translate(-10,-10, 0);
		//gl.rotate(290*t*.03, 1, .5, .4);
		for(i=0;i&lt;5;i++){
			for(j=0;j&lt;5;j++){
				gl.pushMatrix();
				gl.rotate(20*j*audiolevel, 1, .4, 0);
				gl.translate(0, 0, -j*5);
				for(k=0;k&lt;3*audiolevel+1;k++){
					gl.pushMatrix();
					gl.translate(i*2.4*audiolevel, j*3.7*audiolevel, k*2.9*audiolevel);
					drawcube();
					gl.popMatrix();

				}
				gl.popMatrix();
			}
		}
	}
	
</pre>
<img src='http://farm3.static.flickr.com/2380/2377064406_2366ab8d2d.jpg?v=0' id='texture_map'/>