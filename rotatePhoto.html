<!DOCTYPE HTML>
<!-- https://labs.mozilla.com/forum/index.php/topic,58.0.html -->
<!-- http://canvex.lazyilluminati.com/misc/photos.html -->
<title>Canvas 3D &ndash; example</title>
<style>
body {
	font-family: sans-serif;
	background: white;
	color: black;
}
label {
	display: block;
	width: 100%;
}
small {
	position: absolute;
	bottom: 0.5em;
}
</style>

<script type="application/javascript;version=1.7">

function next_pow2(n)
{
	return Math.pow(2, Math.ceil(Math.log(n) / Math.LN2));
}

function status(msg)
{
	document.getElementById('status').innerHTML = msg;
}

function escapeHTML(str)
{
	return str.replace('&', '&amp;').replace('<', '&lt;').replace('>', '&gt;');
}

var api_key = '96bdd36ab44af648a6c99916570a1f0f';
function flickr_url(method, params)
{
	var url = 'http://api.flickr.com/services/rest/?api_key=' + api_key + '&format=json&method=' + method;
	for (var [key, value] in params)
	{
		url += '&'+key+'='+escape(value);
	}
	return url;
}

function request(url, callback)
{
	//if (window.jsonFlickrApi) throw Error();
	window.jsonFlickrApi = function (data)
	{
		delete window.jsonFlickrApi;
		document.body.removeChild(n);
		if (data.stat != 'ok') throw Error();
		callback(data);
	}

	var n = document.createElement('script');
	n.setAttribute('src', url);
	document.body.appendChild(n);
}

var image_buffer = [];

function load_image(gl, img, title)
{
	var [id] = gl.genTextures(1);
	gl.bindTexture(gl.TEXTURE_2D, id);
	gl.texParameter(gl.TEXTURE_2D, gl.GENERATE_MIPMAP, true);
	gl.texParameter(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR);
	gl.texParameter(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
	if ((img.width & (img.width-1)) || (img.height & (img.height-1)))
	{
		// not power-of-two, so resize it using a 2d canvas
		var w = next_pow2(img.width);
		var h = next_pow2(img.height);
		var canvas = document.createElement('canvas');
		canvas.width = w;
		canvas.height = h;
		var ctx = canvas.getContext('2d');
		ctx.drawImage(img, 0, 0, w, h);
		gl.texImage2DHTML(gl.TEXTURE_2D, canvas);
	}
	else
	{
		gl.texImage2DHTML(gl.TEXTURE_2D, img);
	}
	image_buffer.push({ id:id, title:title });
	status("Buffered " + image_buffer.length + " images");
}

window.addEventListener('load', function ()
{
	var canvas = document.getElementById('c');
	try { var gl = canvas.getContext('moz-gles11'); } catch (e) {}
	if (! gl)
	{
		alert("Sorry, your browser does not have the moz-gles11 canvas extension");
		canvas.parentNode.replaceChild(canvas.firstChild, canvas);
		return;
	}

	var got_image_pages = {};
	function get_images(tags)
	{
		var page;
		if (got_image_pages[tags])
			page = ++got_image_pages[tags];
		else
			page = got_image_pages[tags] = 1;

		request(
			flickr_url('flickr.photos.search', { per_page:5, page:page, tags:tags }),
			function (data)
			{
				for ([, photo] in data.photos.photo)
				{
					var img_url = 'http://farm'+photo.farm+'.static.flickr.com/'+photo.server+'/'+photo.id+'_'+photo.secret+'.jpg';
					var i = new Image();
					let title = '<a href="http://www.flickr.com/photos/'+photo.owner+'/'+photo.id+'">'+escapeHTML(photo.title)+'<\/a>';
					i.onload = function () { load_image(gl, this, title) };
					i.src = img_url;
				}
			}
		);
	}

	window.flush_buffer = function()
	{
		image_buffer = [];
		get_images(document.getElementById('tags').value);
	}

	var background = [0, 0, 0, 1];
	// var background = [1, 1, 1, 1];

	flush_buffer();

	gl.matrixMode(gl.PROJECTION);
	gl.loadIdentity();
	gl.gluPerspective(45, 1, 0.1, 100);

	gl.matrixMode(gl.MODELVIEW);

	gl.clearColor(background[0], background[1], background[2], 1);

	gl.enable(gl.DEPTH_TEST);
	gl.cullFace(gl.BACK);
	gl.enable(gl.CULL_FACE);
	
	gl.enable(gl.LIGHTING);
	gl.light(gl.LIGHT0, gl.AMBIENT, [1, 1, 1, 1]);
	gl.light(gl.LIGHT0, gl.DIFFUSE, [1, 1, 1, 1]);
	gl.light(gl.LIGHT0, gl.POSITION, [100, 0, 500, 0]);
	gl.light(gl.LIGHT0, gl.SPECULAR, [1, 1, 1, 1]);
	gl.material(gl.FRONT_AND_BACK, gl.SPECULAR, [1,1,1,1]);
	gl.material(gl.FRONT_AND_BACK, gl.SHININESS, 12);
	
	gl.enable(gl.LIGHT0);

	gl.enableClientState(gl.VERTEX_ARRAY);
	gl.enableClientState(gl.TEXTURE_COORD_ARRAY);
	gl.enableClientState(gl.NORMAL_ARRAY);

	planeObject = function(){
		this.vertices = [
			-1,-1,0, 1,-1,0, -1,1,0,
			-1,1,0, 1,-1,0, 1,1,0,

			1,-1,0, -1,-1,0, -1,1,0,
			1,-1,0, -1,1,0, 1,1,0,
		];
		this.texcoords = [
			0,1, 1,1, 0,0,
			0,0, 1,1, 1,0,
			0,1, 1,1, 1,0,
		   	0,1, 1,0, 0,0,
		];
		this.normals = [
			0,0,1, 0,0,1, 0,0,1,
			0,0,1, 0,0,1, 0,0,1,
			0,0,-1, 0,0,-1, 0,0,-1,
			0,0,-1, 0,0,-1, 0,0,-1,
		];
		this.vertex_buffer = gl.createBuffer(gl.STATIC_DRAW, 3, gl.FLOAT, this.vertices);
		this.texcoord_buffer = gl.createBuffer(gl.STATIC_DRAW, 2, gl.FLOAT, this.texcoords);
		this.normal_buffer = gl.createBuffer(gl.STATIC_DRAW, 3, gl.FLOAT, this.normals);
		
	}
		
	
	plane = new planeObject();
	var drawPlane = function(){
		gl.vertexPointer(plane.vertex_buffer);
		gl.texCoordPointer(plane.texcoord_buffer);
		gl.normalPointer(plane.normal_buffer);
		gl.drawArrays(gl.TRIANGLES, 0, plane.vertices.length / 3);
	}
	
	var drawCube = function(){
		gl.vertexPointer(plane.vertex_buffer);
		gl.texCoordPointer(plane.texcoord_buffer);
		gl.normalPointer(plane.normal_buffer);
		gl.drawArrays(gl.TRIANGLES, 0, plane.vertices.length / 3);
		
		gl.rotate(90, 1, 0, 0);
		gl.translate(0, 1, 1);
		gl.vertexPointer(plane.vertex_buffer);
		gl.texCoordPointer(plane.texcoord_buffer);
		gl.normalPointer(plane.normal_buffer);
		gl.drawArrays(gl.TRIANGLES, 0, plane.vertices.length / 3);		
		
		gl.rotate(90, 0, 1, 0);
		gl.translate(1, 0, 1);
		gl.vertexPointer(plane.vertex_buffer);
		gl.texCoordPointer(plane.texcoord_buffer);
		gl.normalPointer(plane.normal_buffer);
		gl.drawArrays(gl.TRIANGLES, 0, plane.vertices.length / 3);		

		gl.rotate(90, 0, 1, 0);
		gl.translate(1, 0, 1);
		gl.vertexPointer(plane.vertex_buffer);
		gl.texCoordPointer(plane.texcoord_buffer);
		gl.normalPointer(plane.normal_buffer);
		gl.drawArrays(gl.TRIANGLES, 0, plane.vertices.length / 3);
	
		gl.rotate(90, 0, 1, 0);
		gl.translate(1, 0, 1);
		gl.vertexPointer(plane.vertex_buffer);
		gl.texCoordPointer(plane.texcoord_buffer);
		gl.normalPointer(plane.normal_buffer);
		gl.drawArrays(gl.TRIANGLES, 0, plane.vertices.length / 3);		

		gl.rotate(90, 1, 0, 0);
		gl.translate(0, -1, -1);
		gl.vertexPointer(plane.vertex_buffer);
		gl.texCoordPointer(plane.texcoord_buffer);
		gl.normalPointer(plane.normal_buffer);
		gl.drawArrays(gl.TRIANGLES, 0, plane.vertices.length / 3);		
				
	}
	
	var t = 0;
	var turn = 0;
	var speed = 0.002;
	var img_id = 0;
	
	setInterval(function() {
		if (document.getElementById('pause').checked)
			return;

		++t;
		// gl.bindTexture(gl.TEXTURE_2D, img_id);

		gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
		
		gl.loadIdentity();
		gl.translate(0, 0, -30.0)
		gl.pushMatrix();
		gl.gluLookAt(
				0, 0, 3.5,
				0, 0, 0,
				0, 1, 0);
				
		for(i=0;i<1;i++){
			// gl.rotate(speed*t*i*1.50, .8, .4, 0);
			// gl.translate(i*1.202, 0, 0);
			gl.rotate(speed*t*502.3, 1, .4, 0);
			drawCube();
		}
		
		gl.popMatrix();
		gl.swapBuffers();
		
	}, 30);

}, false);

window.loaded_first_script = true;
</script>
<script>
if (! window.loaded_first_script)
{
	alert("Sorry, your browser does not support JavaScript 1.7");
	var canvas = document.getElementById('c');
	canvas.parentNode.replaceChild(canvas.firstChild, canvas); // oops, doesn't work in Opera
}
</script>

<canvas width="800" height="600" id="c"><p>
Sorry, your browser doesn't support this &lt;canvas&gt;.
For a boring alternate version of this page's content, visit
<a href="http://flickr.com">Flickr</a>.

</canvas>

<form onsubmit="flush_buffer(); return false">
<table>
	<tr>
		<td><label for="pause">Pause</label>
		<td><input type="checkbox" id="pause">
	<tr>
		<td><label for="tags">Tag</label>
		<td><input type="text" id="tags" value="canvas">

	<tr>
		<td>Status
		<td><span id="status"></span>
	<tr>
		<td>Now showing
		<td><span id="current"></span>
</table>
</form>

<footer>
	<p><small>This product uses the Flickr API but is not endorsed or certified by Flickr.</small>

</footer>
